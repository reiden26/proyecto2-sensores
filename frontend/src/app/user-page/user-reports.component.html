<div class="reports-container">
  <div class="reports-header">
    <h2><mat-icon class="header-icon">insert_chart</mat-icon> Reportes de Sensores</h2>
    <div class="header-actions">
      <!-- Espacio reservado para mantener la misma estructura que datos -->
    </div>
  </div>

  <!-- Filtros de Reporte -->
  <mat-card class="filters-card">
    <mat-card-header>
      <mat-card-title>Filtros de Reporte</mat-card-title>
      <mat-card-subtitle>Selecciona los criterios para tu reporte</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="filters-grid">
        <!-- Rango de fechas -->
        <div class="filter-group">
          <h4>
            <mat-icon>date_range</mat-icon>
            Rango de Fechas
          </h4>
          <div class="date-inputs">
            <mat-form-field appearance="fill">
              <mat-label>Rango de fechas</mat-label>
              <mat-date-range-input [rangePicker]="picker" [formGroup]="dateForm">
                <input matStartDate formControlName="start" placeholder="Desde">
                <input matEndDate formControlName="end" placeholder="Hasta">
              </mat-date-range-input>
              <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
              <mat-date-range-picker #picker></mat-date-range-picker>
            </mat-form-field>
          </div>
        </div>

        <!-- Sensores -->
        <div class="filter-group">
          <h4>
            <mat-icon>sensors</mat-icon>
            Sensores
          </h4>
          <div class="sensor-options">
            <div class="toggle-item">
              <div class="toggle-info">
                <mat-icon>air</mat-icon>
                <span>MQ-135 (Calidad del Aire)</span>
              </div>
              <mat-slide-toggle [(ngModel)]="sensorSelections.mq135" [ngModelOptions]="{standalone: true}" (change)="updateSensorSelection()" color="primary"></mat-slide-toggle>
            </div>
            <div class="toggle-item">
              <div class="toggle-info">
                <mat-icon>gas_meter</mat-icon>
                <span>MQ-4 (Metano)</span>
              </div>
              <mat-slide-toggle [(ngModel)]="sensorSelections.mq4" [ngModelOptions]="{standalone: true}" (change)="updateSensorSelection()" color="primary"></mat-slide-toggle>
            </div>
            <div class="toggle-item">
              <div class="toggle-info">
                <mat-icon>warning</mat-icon>
                <span>MQ-7 (Monóxido de Carbono)</span>
              </div>
              <mat-slide-toggle [(ngModel)]="sensorSelections.mq7" [ngModelOptions]="{standalone: true}" (change)="updateSensorSelection()" color="primary"></mat-slide-toggle>
            </div>
          </div>
        </div>

        <!-- Severidades -->
        <div class="filter-group">
          <h4>
            <mat-icon>priority_high</mat-icon>
            Niveles de Alerta
          </h4>
          <div class="severity-options">
            <div class="toggle-item">
              <div class="toggle-info">
                <mat-icon style="color: #4caf50;">check_circle</mat-icon>
                <span>Bueno</span>
              </div>
              <mat-slide-toggle [(ngModel)]="severitySelections.bueno" [ngModelOptions]="{standalone: true}" (change)="updateSeveritySelection()" color="primary"></mat-slide-toggle>
            </div>
            <div class="toggle-item">
              <div class="toggle-info">
                <mat-icon style="color: #ff9800;">warning</mat-icon>
                <span>Advertencia</span>
              </div>
              <mat-slide-toggle [(ngModel)]="severitySelections.advertencia" [ngModelOptions]="{standalone: true}" (change)="updateSeveritySelection()" color="primary"></mat-slide-toggle>
            </div>
            <div class="toggle-item">
              <div class="toggle-info">
                <mat-icon style="color: #f44336;">error</mat-icon>
                <span>Malo</span>
              </div>
              <mat-slide-toggle [(ngModel)]="severitySelections.malo" [ngModelOptions]="{standalone: true}" (change)="updateSeveritySelection()" color="primary"></mat-slide-toggle>
            </div>
          </div>
        </div>

        <!-- Opciones adicionales -->
        <div class="filter-group">
          <h4>
            <mat-icon>settings</mat-icon>
            Opciones de Reporte
          </h4>
          <div class="sensor-options">
            <div class="toggle-item">
              <div class="toggle-info">
                <mat-icon>bar_chart</mat-icon>
                <span>Incluir gráficos comparativos</span>
              </div>
              <mat-slide-toggle [(ngModel)]="filters.incluirGraficos" color="primary"></mat-slide-toggle>
            </div>
          </div>
        </div>
      </div>
    </mat-card-content>
    <mat-card-actions>
      <div class="button-container">
        <div class="validation-hint" *ngIf="!isFormValid() && !loading">
          <mat-icon>info</mat-icon>
          <span>Selecciona al menos un sensor y una severidad para generar el reporte</span>
        </div>
        <div class="button-group">
          <button mat-raised-button color="primary" (click)="generarReporte()" [disabled]="loading || !isFormValid()">
            <mat-icon>assessment</mat-icon>
            Generar Reporte
          </button>
          <button mat-stroked-button (click)="limpiarFiltros()" [disabled]="loading">
            <mat-icon>clear</mat-icon>
            Limpiar
          </button>
        </div>
      </div>
    </mat-card-actions>
  </mat-card>

  <!-- Resultados del Reporte -->
  <div *ngIf="reportData && hasData" class="report-results">
    <!-- Resumen de datos -->
    <mat-card class="summary-card">
      <mat-card-header>
        <mat-card-title>Resumen de Datos</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="summary-stats">
          <div class="stat-item" *ngIf="reportData.mq135.length > 0">
            <mat-icon>air</mat-icon>
            <span>MQ-135: {{ reportData.mq135.length }} lecturas</span>
          </div>
          <div class="stat-item" *ngIf="reportData.mq4.length > 0">
            <mat-icon>gas_meter</mat-icon>
            <span>MQ-4: {{ reportData.mq4.length }} lecturas</span>
          </div>
          <div class="stat-item" *ngIf="reportData.mq7.length > 0">
            <mat-icon>warning</mat-icon>
            <span>MQ-7: {{ reportData.mq7.length }} lecturas</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Gráficos -->
    <mat-card *ngIf="filters.incluirGraficos && hasChartData" class="charts-card">
      <mat-card-header>
        <mat-card-title>Gráficos Comparativos</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="chart-container">
          <canvas #comparisonChart></canvas>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Botón de exportación removido: el modal se abre tras Generar Reporte -->
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Generando reporte...</p>
  </div>

  <!-- No data -->
  <div *ngIf="!loading && reportData && !hasData" class="no-data">
    <mat-icon>info</mat-icon>
    <p>No se encontraron datos con los filtros seleccionados</p>
  </div>
</div>
