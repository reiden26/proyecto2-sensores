<div class="reports-container">
  <!-- Header Card -->
  <mat-card class="header-card">
    <mat-card-header>
      <div class="header-avatar">
        <mat-icon>assessment</mat-icon>
      </div>
      <div>
        <mat-card-title>Dashboard de Reportes</mat-card-title>
        <mat-card-subtitle>An√°lisis y monitoreo del sistema de sensores</mat-card-subtitle>
        <div class="realtime-indicator">
          
        
        </div>
      </div>
    </mat-card-header>
  </mat-card>

  <!-- M√©tricas principales -->
  <mat-card class="metrics-card">
    <mat-card-content>
      <div class="metrics-grid">
        <div class="metric-item">
          <div class="metric-icon">
            <mat-icon>sensors</mat-icon>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ totalSensors }}</div>
            <div class="metric-label">Total Sensores</div>
          </div>
        </div>

        <div class="metric-item">
          <div class="metric-icon active">
            <mat-icon>check_circle</mat-icon>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ activeSensors }}</div>
            <div class="metric-label">Activos</div>
          </div>
        </div>


        <div class="metric-item">
          <div class="metric-icon inactive">
            <mat-icon>error</mat-icon>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ inactiveSensors }}</div>
            <div class="metric-label">Inactivos</div>
          </div>
        </div>

        <div class="metric-item">
          <div class="metric-icon alert">
            <mat-icon>notifications</mat-icon>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ activeAlerts }}</div>
            <div class="metric-label">Alertas</div>
          </div>
        </div>

      </div>
    </mat-card-content>
  </mat-card>

  <!-- Filtros y Acciones -->
  <mat-card class="filters-card">
    <mat-card-content>
      <div class="filters-container">
        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Sensor</mat-label>
          <mat-select [(value)]="selectedSensor" (selectionChange)="onChangeSensor()">
            <mat-option value="">Todos los sensores</mat-option>
            <mat-option *ngFor="let sensor of sensors" [value]="sensor.name">
              {{ sensor.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Rango de fecha</mat-label>
          <mat-select [(value)]="selectedDateRange" (selectionChange)="onChangeDateRange()">
            <mat-option value="today">Hoy</mat-option>
            <mat-option value="week">Esta semana</mat-option>
            <mat-option value="month">Este mes</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Severidad de alertas</mat-label>
          <mat-select [(value)]="selectedAlertSeverity" (selectionChange)="onChangeSeverity()">
            <mat-option value="">Todas</mat-option>
            <mat-option value="bueno">Bueno</mat-option>
            <mat-option value="advertencia">Advertencia</mat-option>
            <mat-option value="malo">Mala</mat-option>
          </mat-select>
        </mat-form-field>

        <div class="actions">
        <button mat-raised-button color="accent" (click)="abrirDialogoExportar()">
          <mat-icon>file_download</mat-icon>
          Exportar
        </button>
          
          
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Tabs de reportes -->
  <mat-card class="tabs-card">
    <mat-tab-group>
      <!-- Tab 1: Dashboard de Sensores -->
      <mat-tab label="Panel de Sensores">
        <div class="tab-content">
          <!-- Estado de sensores -->
          <mat-card class="sensors-status-card">
            <mat-card-header>
              <mat-card-title>Estado de Sensores</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="sensors-grid">
                <mat-card *ngFor="let sensor of sensoresFiltrados" class="sensor-card" [ngClass]="'status-' + sensor.status">
                  <mat-card-content>
                    <div class="sensor-header">
                      <mat-icon [color]="getStatusColor(sensor.status)">{{ getSensorIcon(sensor.name) }}</mat-icon>
                      <div class="sensor-info">
                        <div class="sensor-name">{{ sensor.name }}</div>
                        <div class="sensor-type">{{ sensor.type }}</div>
                      </div>
                      <mat-chip [color]="getStatusColor(sensor.status)" selected>
                        {{ sensor.status === 'active' ? 'Activo' : 'Inactivo' }}
                      </mat-chip>
                    </div>
                    <div class="sensor-value" *ngIf="sensor.status !== 'inactive'">
                      <span class="value">{{ sensor.lastValue | number:'1.2-2' }}</span>
                      <span class="unit">{{ sensor.unit }}</span>
                    </div>
                    <div class="sensor-update">
                      √öltima actualizaci√≥n: {{ sensor.lastUpdate | date:'short' }}
                    </div>
                  </mat-card-content>
                </mat-card>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Carrusel de 3 gr√°ficas mostrando 2 a la vez -->
          <div class="charts-carousel" [class.slide-next]="animationClass==='slide-next'" [class.slide-prev]="animationClass==='slide-prev'">
            <button mat-icon-button class="nav prev" (click)="prevCharts()" aria-label="Anterior">
              <mat-icon>chevron_left</mat-icon>
            </button>
            <div class="charts-container" [class.enter-next]="animationClass==='enter-next'" [class.enter-prev]="animationClass==='enter-prev'">
              <mat-card class="chart-card" *ngFor="let chart of getVisibleCharts()" [style.display]="shouldShowChart(chart.key) ? 'block' : 'none'">
                <mat-card-header>
                  <div class="chart-header">
                    <div class="chart-header-left">
                      <div class="chart-icon" [style.background]="chart.color">
                        <mat-icon>show_chart</mat-icon>
                      </div>
                      <div class="chart-titles">
                        <mat-card-title>{{ chart.title }}</mat-card-title>
                        <mat-card-subtitle>{{ chart.subtitle }}</mat-card-subtitle>
                      </div>
                    </div>
                    <div class="chart-header-right">
                      <span class="chart-badge">{{ chart.unit }}</span>
                    </div>
                  </div>
                </mat-card-header>
                <mat-card-content>
                  <div class="chart-container">
                    <div class="chart-title">{{ chart.subtitle }}</div>
                    <div class="chart-wrapper">
                      <svg class="chart-svg" viewBox="0 0 400 200">
                        <defs>
                          <pattern [attr.id]="'grid-' + chart.key" width="40" height="20" patternUnits="userSpaceOnUse">
                            <path d="M 40 0 L 0 0 0 20" fill="none" stroke="#e2e8f0" stroke-width="0.5"/>
                          </pattern>
                        </defs>
                        <rect width="100%" height="100%" [attr.fill]="'url(#grid-' + chart.key + ')'"/>
                        
                        <polyline 
                          *ngIf="getSafeDataByKey(chart.key)?.length"
                          [attr.points]="getChartPointsByKey(chart.key)" 
                          fill="none" 
                          [attr.stroke]="chart.color" 
                          stroke-width="3"
                          stroke-linecap="round"
                          stroke-linejoin="round"/>
                        
                        <ng-container *ngFor="let point of getSafeDataByKey(chart.key); let i = index">
                          <circle 
                            [attr.cx]="getXPosition(i)" 
                            [attr.cy]="getYPosition(point.value, getSafeDataByKey(chart.key))" 
                            r="4" 
                            [attr.fill]="chart.color" 
                            stroke="#ffffff" 
                            stroke-width="2"/>
                        </ng-container>
                      </svg>
                    </div>
                    <div class="data-points">
                      <div *ngFor="let point of getSafeDataByKey(chart.key)" class="data-point">
                        <span class="time">{{ point.time }}</span>
                        <span class="value">{{ point.value | number:'1.2-2' }} {{ chart.unit }}</span>
                      </div>
                    </div>
                  </div>
                </mat-card-content>
              </mat-card>
            </div>
            <button mat-icon-button class="nav next" (click)="nextCharts()" aria-label="Siguiente">
              <mat-icon>chevron_right</mat-icon>
            </button>
          </div>
        </div>
      </mat-tab>

      <!-- Tab 2: Reporte de Alertas -->
      <mat-tab label="Alertas">
        <div class="tab-content">
          <mat-card class="alerts-card">
            <mat-card-header>
              <mat-card-title>Alertas del Sistema</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div *ngIf="alertasFiltradas.length === 0" class="no-alerts">
                <mat-icon>check_circle</mat-icon>
                <p>No hay alertas para el rango seleccionado</p>
              </div>
              <div *ngIf="isLoadingAlerts" class="alerts-loading"><mat-spinner diameter="28"></mat-spinner></div>
              <mat-list *ngIf="alertasPaginadas.length > 0 && !isLoadingAlerts">
                <mat-list-item *ngFor="let alert of alertasPaginadas"
                               class="alert-item"
                               [matTooltip]="'Usuario: ' + ((alert.usuario || alert.usuario_nombre) || '‚Äî') + '\n' + 'Correo: ' + (alert.correo || alert.email || '‚Äî') + '\n' + 'Fecha: ' + ((alert.timestamp || alert.creado_en) | date:'short')"
                               matTooltipClass="alert-tooltip"
                               matTooltipPosition="above"
                               [matTooltipShowDelay]="150"
                               [matTooltipHideDelay]="50">
                  <mat-icon matListItemIcon [ngClass]="getSeverityClass(alert.severidad)">
                    {{ alert.severidad === 'malo' ? 'error' : (alert.severidad === 'advertencia' ? 'warning' : 'check_circle') }}
                  </mat-icon>
                  <div matListItemTitle>{{ alert.mensaje }}</div>
                  <div matListItemLine>
                    <strong>{{ alert.sensor_nombre }}</strong> ‚Äî 
                    Valor: {{ alert.valor | number:'1.2-2' }} ppm
                  </div>
                </mat-list-item>
              </mat-list>

              <!-- Paginaci√≥n de alertas (Angular Material) -->
              <mat-paginator
                [length]="alertasFiltradas.length"
                [pageIndex]="alertCurrentPage"
                [pageSize]="alertPageSize"
                [pageSizeOptions]="pageSizeOptionsAlertas"
                showFirstLastButtons
                (page)="onPageAlertas($event)">
              </mat-paginator>
            </mat-card-content>
          </mat-card>

          <!-- Alertas personalizadas -->
          <mat-card class="alerts-card" style="margin-top: 16px;">
            <mat-card-header>
              <mat-card-title>Alertas personalizadas</mat-card-title>
              <mat-card-subtitle></mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <div *ngIf="alertasPersonalizadasData.length === 0 && !isLoadingAlerts" class="no-alerts">
                <mat-icon>info</mat-icon>
                <p>No hay alertas personalizadas para el rango seleccionado</p>
              </div>
              <div class="alerts-loading" *ngIf="isLoadingAlerts"><mat-spinner diameter="28"></mat-spinner></div>
              <mat-list *ngIf="alertasPersonalizadasPaginadas.length > 0 && !isLoadingAlerts">
                <mat-list-item *ngFor="let ap of alertasPersonalizadasPaginadas"
                               class="alert-item"
                               [matTooltip]="'Usuario: ' + (ap.usuario_nombre || '‚Äî') + '\nCorreo: ' + (ap.email || '‚Äî') + '\nUmbral: ' + (ap.umbral_usado ?? '‚Äî') + ' (' + ap.tipo_trigger + ')\nFecha: ' + (ap.creado_en | date:'short')"
                               matTooltipClass="alert-tooltip"
                               matTooltipPosition="above"
                               [matTooltipShowDelay]="150"
                               [matTooltipHideDelay]="50">
                  <mat-icon matListItemIcon [ngClass]="getSeverityClass(ap.severidad || '')">flag</mat-icon>
                  <div matListItemTitle>Trigger {{ ap.sensor }}</div>
                  <div matListItemLine>
                    Valor: {{ ap.valor | number:'1.2-2' }} ‚Ä¢ Umbral: {{ ap.umbral_usado ?? '‚Äî' }} ({{ ap.tipo_trigger }})
                  </div>
                </mat-list-item>
              </mat-list>
              <mat-paginator
                *ngIf="!isLoadingAlerts"
                [length]="alertasPersonalizadasFiltradas.length"
                [pageIndex]="0"
                [pageSize]="5"
                [pageSizeOptions]="[5, 10, 20, 100]"
                showFirstLastButtons
                (page)="alertasPersonalizadasPaginadas = alertasPersonalizadasFiltradas.slice($event.pageIndex * $event.pageSize, $event.pageIndex * $event.pageSize + $event.pageSize)">
              </mat-paginator>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <!-- Tab 3: Reporte de Usuarios -->
      <mat-tab label="Usuarios">
        <div class="tab-content">
          <mat-card class="users-card">
            <mat-card-header>
              <mat-card-title>Estados de Usuarios</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="users-stats">
                <div class="stat-item">
                  <mat-icon>people</mat-icon>
                  <div>
                    <div class="stat-value">
                      <mat-spinner *ngIf="isLoading" diameter="20"></mat-spinner>
                      <span *ngIf="!isLoading">{{ regularUsers }}</span>
                    </div>
                    <div class="stat-label">Usuarios Regulares</div>
                  </div>
                </div>
                <div class="stat-item">
                  <mat-icon>admin_panel_settings</mat-icon>
                  <div>
                    <div class="stat-value">
                      <mat-spinner *ngIf="isLoading" diameter="20"></mat-spinner>
                      <span *ngIf="!isLoading">{{ adminUsers }}</span>
                    </div>
                    <div class="stat-label">Administradores</div>
                  </div>
                </div>
                <div class="stat-item">
                  <mat-icon>group</mat-icon>
                  <div>
                    <div class="stat-value">
                      <mat-spinner *ngIf="isLoading" diameter="20"></mat-spinner>
                      <span *ngIf="!isLoading">{{ totalUsers }}</span>
                    </div>
                    <div class="stat-label">Total Usuarios</div>
                  </div>
                </div>
              </div>

              <mat-divider></mat-divider>

              <!-- Filtro de estado de conexi√≥n para usuarios -->
              <div class="users-filter-section">
                <mat-form-field appearance="outline" class="users-filter-field">
                  <mat-label>Estado de conexi√≥n</mat-label>
                  <mat-select [(value)]="selectedConnectionStatus" (selectionChange)="onConnectionStatusChange()">
                    <mat-option value="">Todos los usuarios</mat-option>
                    <mat-option value="connected">üü¢ Conectados</mat-option>
                    <mat-option value="disconnected">üî¥ Desconectados</mat-option>
                  </mat-select>
                </mat-form-field>
                
                <div class="users-filter-info">
                  <span class="filter-count">
                    Mostrando {{ usuariosPaginados.length }} de {{ getFilteredUsers().length }} usuarios
                  </span>
                </div>
              </div>

              <mat-list>
                <mat-list-item *ngFor="let user of usuariosPaginados" class="user-item">
                  <div class="user-avatar" matListItemIcon>
                    <img *ngIf="user.imagen_url" [src]="user.imagen_url" [alt]="user.nombre" class="user-image">
                    <mat-icon *ngIf="!user.imagen_url">person</mat-icon>
                  </div>
                  <div matListItemTitle>{{ user.nombre }}</div>
                  <div matListItemLine>
                    <strong>{{ user.rol === 'admin' ? 'Administrador' : 'Usuario' }}</strong> ‚Ä¢ {{ user.sensores_asignados }} sensores asignados
                  </div>
                  <div matListItemLine>
                    <span class="email-info">
                      <mat-icon class="email-icon">email</mat-icon>
                      {{ user.email || 'Sin correo' }}
                    </span>
                  </div>
                  <div matListItemLine>
                    <span [class.connected]="user.esta_conectado" [class.disconnected]="!user.esta_conectado">
                      {{ user.esta_conectado ? 'üü¢ Conectado' : 'üî¥ Desconectado' }}
                    </span>
                    <span *ngIf="!user.esta_conectado && user.ultima_conexion">
                      ‚Ä¢ √öltima conexi√≥n: {{ user.ultima_conexion | date:'short' }}
                    </span>
                  </div>
                  <div matListItemLine *ngIf="user.duracion_ultima_sesion > 0 || user.total_lecturas >= 0">
                    <ng-container *ngIf="user.ultima_sesion_inicio || user.ultima_sesion_fin; else simpleStats">
                      √öltima sesi√≥n
                      <ng-container *ngIf="user.ultima_sesion_inicio"> ‚Äî Inicio: {{ user.ultima_sesion_inicio | date:'short' }}</ng-container>
                      <ng-container *ngIf="user.ultima_sesion_fin"> ‚Ä¢ Fin: {{ user.ultima_sesion_fin | date:'short' }}</ng-container>
                      <ng-container *ngIf="user.duracion_ultima_sesion"> ‚Ä¢ Duraci√≥n: {{ user.duracion_ultima_sesion }} min</ng-container>
                      <ng-container *ngIf="user.total_lecturas >= 0"> ‚Ä¢ Registros: {{ user.total_lecturas }}</ng-container>
                    </ng-container>
                    <ng-template #simpleStats>
                      <ng-container *ngIf="user.duracion_ultima_sesion">Duraci√≥n √∫ltima sesi√≥n: {{ user.duracion_ultima_sesion }} min ‚Ä¢ </ng-container>
                      Registros: {{ user.total_lecturas }}
                    </ng-template>
                  </div>
                </mat-list-item>
              </mat-list>
              
              <!-- Controles de paginaci√≥n -->
              <div *ngIf="usuariosTotalPages > 1" class="pagination-controls">
                <div class="pagination-info">
                  P√°gina {{ usuariosCurrentPage + 1 }} de {{ usuariosTotalPages }}
                  ({{ usuariosData?.actividad_usuarios?.length || 0 }} usuarios total)
                </div>
                <div class="pagination-buttons">
                  <button mat-button 
                          [disabled]="usuariosCurrentPage === 0"
                          (click)="paginaAnteriorUsuarios()">
                    <mat-icon>chevron_left</mat-icon>
                    Anterior
                  </button>
                  
                  <div class="page-numbers">
                    <button *ngFor="let page of [].constructor(usuariosTotalPages); let i = index"
                            mat-button
                            [class.active]="i === usuariosCurrentPage"
                            (click)="irAPaginaUsuarios(i)">
                      {{ i + 1 }}
                    </button>
                  </div>
                  
                  <button mat-button 
                          [disabled]="usuariosCurrentPage === usuariosTotalPages - 1"
                          (click)="siguientePaginaUsuarios()">
                    Siguiente
                    <mat-icon>chevron_right</mat-icon>
                  </button>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <!-- Tab 4: Reporte Temporal -->
      <mat-tab label="An√°lisis Temporal">
        <div class="tab-content">
          <mat-card class="temporal-card">
            <mat-card-header>
              <mat-card-title>An√°lisis por Per√≠odo</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="temporal-stats">
                <div class="temporal-item">
                  <mat-icon>today</mat-icon>
                  <div>
                    <div class="temporal-value">{{ temporalData.hoy | number }}</div>
                    <div class="temporal-label">Registros Hoy</div>
                  </div>
                </div>
                <div class="temporal-item">
                  <mat-icon>date_range</mat-icon>
                  <div>
                    <div class="temporal-value">{{ temporalData.semana | number }}</div>
                    <div class="temporal-label">Esta Semana</div>
                  </div>
                </div>
                <div class="temporal-item">
                  <mat-icon>calendar_month</mat-icon>
                  <div>
                    <div class="temporal-value">{{ temporalData.mes | number }}</div>
                    <div class="temporal-label">Este Mes</div>
                  </div>
                </div>
              </div>

              <mat-divider></mat-divider>

              <div class="comparison-chart">
                <h3>Comparaci√≥n de Sensores - {{ selectedDateRange === 'week' ? 'Esta semana' : (selectedDateRange === 'month' ? 'Este mes' : '√öltimas 24h') }}</h3>
                <div class="chart-container">
                  <div class="chart-wrapper">
                    <svg class="chart-svg" viewBox="0 0 600 300">
                      <!-- Grid lines -->
                      <defs>
                        <pattern id="temporalGrid" width="50" height="30" patternUnits="userSpaceOnUse">
                          <path d="M 50 0 L 0 0 0 30" fill="none" stroke="#e2e8f0" stroke-width="0.5"/>
                        </pattern>
                      </defs>
                      <rect width="100%" height="100%" fill="url(#temporalGrid)"/>
                      
                      <!-- MQ-135 line -->
                      <polyline 
                        [attr.points]="getTemporalChartPoints('pm25')" 
                        fill="none" 
                        stroke="#667eea" 
                        stroke-width="3"
                        stroke-linecap="round"
                        stroke-linejoin="round"/>
                      
                      <!-- MQ-7 line -->
                      <polyline 
                        [attr.points]="getTemporalChartPoints('air')" 
                        fill="none" 
                        stroke="#f59e0b" 
                        stroke-width="3"
                        stroke-linecap="round"
                        stroke-linejoin="round"/>
                      
                      <!-- MQ-4 line -->
                      <polyline 
                        [attr.points]="getTemporalChartPoints('methane')" 
                        fill="none" 
                        stroke="#ef4444" 
                        stroke-width="3"
                        stroke-linecap="round"
                        stroke-linejoin="round"/>
                      
                      
                      <!-- Data points for MQ-135 -->
                      <circle 
                        *ngFor="let point of pm25Data; let i = index" 
                        [attr.cx]="getTemporalXPosition(i)" 
                        [attr.cy]="getTemporalYPosition(point.value, 'pm25')" 
                        r="4" 
                        fill="#667eea" 
                        stroke="#ffffff" 
                        stroke-width="2"/>
                      
                      <!-- Data points for MQ-7 -->
                      <circle 
                        *ngFor="let point of airQualityData; let i = index" 
                        [attr.cx]="getTemporalXPosition(i)" 
                        [attr.cy]="getTemporalYPosition(point.value, 'air')" 
                        r="4" 
                        fill="#f59e0b" 
                        stroke="#ffffff" 
                        stroke-width="2"/>
                      
                      <!-- Data points for MQ-4 -->
                      <circle 
                        *ngFor="let point of methaneData; let i = index" 
                        [attr.cx]="getTemporalXPosition(i)" 
                        [attr.cy]="getTemporalYPosition(point.value, 'methane')" 
                        r="4" 
                        fill="#ef4444" 
                        stroke="#ffffff" 
                        stroke-width="2"/>
                      
                    </svg>
                  </div>
                  
                  <!-- Legend -->
                  <div class="chart-legend">
                    <div class="legend-item">
                      <div class="legend-color" style="background-color: #667eea;"></div>
                      <span>MQ-135 - Calidad del Aire</span>
                    </div>
                    <div class="legend-item">
                      <div class="legend-color" style="background-color: #f59e0b;"></div>
                      <span>MQ-7 - Mon√≥xido de Carbono</span>
                    </div>
                    <div class="legend-item">
                      <div class="legend-color" style="background-color: #ef4444;"></div>
                      <span>MQ-4 - Gas Metano</span>
                    </div>
                  </div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <!-- Tab 5: Notificaciones -->
      <mat-tab label="Notificaciones">
        <div class="tab-content">
          <mat-card class="alerts-card">
            <mat-card-header>
              <mat-card-title>Notificaciones del Sistema</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="notif-toolbar">
                <button mat-flat-button color="primary" (click)="crearNotificacion()">
                  <mat-icon>add</mat-icon>
                  Nueva
                </button>
                <button mat-stroked-button (click)="mostrarFiltros = !mostrarFiltros">
                  <mat-icon>tune</mat-icon>
                  {{ mostrarFiltros ? 'Ocultar filtros' : 'Mostrar filtros' }}
                </button>
                <span class="spacer"></span>
                <mat-form-field appearance="outline" class="filter-field">
                  <mat-label>Buscar</mat-label>
                  <input matInput [(ngModel)]="notifFiltroTexto" (ngModelChange)="aplicarFiltroNotificaciones()" placeholder="Texto libre" />
                  <mat-icon matSuffix>search</mat-icon>
                </mat-form-field>
              </div>

              <!-- Filtros avanzados togglables -->
              <div class="notif-filters" *ngIf="mostrarFiltros">
                <mat-form-field appearance="outline">
                  <mat-label>Tipo</mat-label>
                  <mat-select [(ngModel)]="filtroTipo" (selectionChange)="aplicarFiltroNotificaciones()">
                    <mat-option value="">Todos</mat-option>
                    <mat-option value="info">Info</mat-option>
                    <mat-option value="warning">Warning</mat-option>
                    <mat-option value="danger">Danger</mat-option>
                  </mat-select>
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>Estado</mat-label>
                  <mat-select [(ngModel)]="filtroEstado" (selectionChange)="aplicarFiltroNotificaciones()">
                    <mat-option value="">Todos</mat-option>
                    <mat-option value="bueno">Bueno</mat-option>
                    <mat-option value="advertencia">Advertencia</mat-option>
                    <mat-option value="malo">Malo</mat-option>
                    <mat-option value="desconectado">Desconectado</mat-option>
                  </mat-select>
                </mat-form-field>
                <mat-form-field appearance="outline">
                  <mat-label>Sensor</mat-label>
                  <mat-select [(ngModel)]="filtroSensor" (selectionChange)="aplicarFiltroNotificaciones()">
                    <mat-option value="">Todos</mat-option>
                    <mat-option value="mq135">MQ-135</mat-option>
                    <mat-option value="mq7">MQ-7</mat-option>
                    <mat-option value="mq4">MQ-4</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

              <div class="table-wrapper">
                <div class="alerts-loading" *ngIf="isLoadingNotifs"><mat-spinner diameter="32"></mat-spinner></div>
                <table *ngIf="!isLoadingNotifs" mat-table [dataSource]="notificacionesDataSource" class="mat-elevation-z1 notif-table" [class.has-paginator]="true">
                  <!-- ID -->
                  <ng-container matColumnDef="id">
                    <th mat-header-cell *matHeaderCellDef>ID</th>
                    <td mat-cell *matCellDef="let row">{{ row.id }}</td>
                  </ng-container>

                  <!-- Usuario -->
                  <ng-container matColumnDef="usuario_id">
                    <th mat-header-cell *matHeaderCellDef>Usuario</th>
                    <td mat-cell *matCellDef="let row">
                      <span class="badge">{{ row.usuario_nombre || row.usuario_id }}</span>
                    </td>
                  </ng-container>

                  <!-- Sensor -->
                  <ng-container matColumnDef="sensor_codigo">
                    <th mat-header-cell *matHeaderCellDef>Sensor</th>
                    <td mat-cell *matCellDef="let row">
                      <span class="badge badge-sensor">{{ row.sensor_codigo === 'mq135' ? 'MQ-135' : (row.sensor_codigo === 'mq7' ? 'MQ-7' : (row.sensor_codigo === 'mq4' ? 'MQ-4' : row.sensor_codigo)) }}</span>
                    </td>
                  </ng-container>

                  <!-- Valor -->
                  <ng-container matColumnDef="valor">
                    <th mat-header-cell *matHeaderCellDef>Valor</th>
                    <td mat-cell *matCellDef="let row">
                      <span>{{ row.valor | number:'1.2-2' }}</span>
                    </td>
                  </ng-container>

                  <!-- Estado -->
                  <ng-container matColumnDef="estado">
                    <th mat-header-cell *matHeaderCellDef>Estado</th>
                    <td mat-cell *matCellDef="let row">
                      <span class="badge"
                        [ngClass]="{
                          'badge-estado-bueno': row.estado==='bueno',
                          'badge-estado-advertencia': row.estado==='advertencia',
                          'badge-estado-malo': row.estado==='malo',
                          'badge-estado-desconectado': row.estado==='desconectado'
                        }">
                        {{ row.estado | titlecase }}
                      </span>
                    </td>
                  </ng-container>

                  <!-- T√≠tulo -->
                  <ng-container matColumnDef="titulo">
                    <th mat-header-cell *matHeaderCellDef>T√≠tulo</th>
                    <td mat-cell *matCellDef="let row">
                      <span>{{ row.titulo }}</span>
                    </td>
                  </ng-container>

                  <!-- Tipo -->
                  <ng-container matColumnDef="tipo">
                    <th mat-header-cell *matHeaderCellDef>Tipo</th>
                    <td mat-cell *matCellDef="let row">
                      <span class="badge"
                        [ngClass]="{
                          'badge-tipo-info': row.tipo==='info',
                          'badge-tipo-warning': row.tipo==='warning',
                          'badge-tipo-danger': row.tipo==='danger'
                        }">
                        {{ row.tipo | titlecase }}
                      </span>
                    </td>
                  </ng-container>

                  <!-- Le√≠da -->
                  <ng-container matColumnDef="leida">
                    <th mat-header-cell *matHeaderCellDef>Le√≠da</th>
                    <td mat-cell *matCellDef="let row">
                      <mat-checkbox [(ngModel)]="row.leida" (change)="actualizarNotificacion(row)" [disabled]="row.leida"></mat-checkbox>
                    </td>
                  </ng-container>

                  <!-- Creado -->
                  <ng-container matColumnDef="creado_en">
                    <th mat-header-cell *matHeaderCellDef>Creado</th>
                    <td mat-cell *matCellDef="let row">{{ row.creado_en | date:'short' }}</td>
                  </ng-container>

                  <!-- Acciones -->
                  <ng-container matColumnDef="acciones">
                    <th mat-header-cell *matHeaderCellDef>Acciones</th>
                    <td mat-cell *matCellDef="let row">
                      <button mat-icon-button class="action-btn edit" color="primary" (click)="abrirDialogoEditar(row)" title="Editar">
                        <mat-icon>edit</mat-icon>
                      </button>
                      <button mat-icon-button class="action-btn delete" color="warn" (click)="eliminarNotificacion(row)" title="Eliminar">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="notificacionesDisplayedColumns"></tr>
                  <tr mat-row *matRowDef="let row; columns: notificacionesDisplayedColumns;" [ngClass]="{'row-info': row.tipo==='info', 'row-warning': row.tipo==='warning', 'row-danger': row.tipo==='danger'}"></tr>
                </table>
                <mat-paginator #notifPaginator [pageSize]="10" [pageSizeOptions]="[5,10,20,50]" showFirstLastButtons></mat-paginator>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>
    </mat-tab-group>
  </mat-card>
</div>
